<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Liste des v√©hicules</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <a href="/" class="btn btn-secondary mb-3">‚Üê Retour √† l'accueil</a>
        <h2>üöô Gestion du parc de v√©hicules</h2>
        <div>
            <a href="/ui/vehicules/random" class="btn btn-warning me-2">üé≤ G√©n√©rer v√©hicule al√©atoire</a>
            <a href="/ui/vehicules/new" class="btn btn-success">+ Ajouter un v√©hicule</a>
        </div>

        <table class="table table-striped table-hover mt-3 shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Marque/Mod√®le</th>
                    <th>Immatriculation</th>
                    <th>√âtat</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Boucle Thymeleaf pour le rendu -->
                <tr th:each="v : ${vehicules}">
                    <td th:text="${v.id}">1</td>
                    <td th:text="${v.marque + ' ' + v.modele}">Peugeot 208</td>
                    <td th:text="${v.immatriculation}">AB-123-CD</td>
                    <td>
                        <!-- Affichage d'un badge color√© selon l'√©tat -->
                        <span th:text="${v.etat != null ? v.etat : 'Inconnu'}" 
                            th:class="${v.etat != null && v.etat.name() == 'DISPONIBLE' ? 'badge bg-success' : 
                                    (v.etat != null && v.etat.name() == 'EN_PANNE' ? 'badge bg-danger' : 'badge bg-secondary')}">
                        </span>
                    </td>
                    <td>
                        <a th:href="@{/ui/vehicules/edit/{id}(id=${v.id})}" class="btn btn-sm btn-outline-primary">‚úèÔ∏è</a>
                        <a th:href="@{/ui/vehicules/delete/{id}(id=${v.id})}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Confirmer la suppression ?')">üóëÔ∏è</a>
                        
                        <!-- Bouton "D√©clarer panne" uniquement pour les v√©hicules non en panne -->
                        <button th:if="${v.etat != null && v.etat.name() != 'EN_PANNE'}"
                                th:onclick="'declarerPanne(' + ${v.id} + ')'" 
                                class="btn btn-sm btn-outline-danger">
                            ‚ö†Ô∏è D√©clarer une panne
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        function declarerPanne(id) {
            if(confirm('√ätes-vous s√ªr de vouloir d√©clarer ce v√©hicule en panne ? Cela annulera automatiquement les contrats en attente associ√©s.')) {
                fetch('/api/vehicules/' + id + '/panne', { method: 'POST' })
                    .then(response => {
                        if(response.ok) {
                            alert('Panne d√©clar√©e avec succ√®s !');
                            location.reload();
                        } else {
                            alert('√âchec de la d√©claration');
                        }
                    });
            }
        }
    </script>
</body>
</html>