<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Contrats')}"></head>
<body>
    <nav th:replace="~{fragments/layout :: navbar}"></nav>

    <div class="container">
        <!-- Barre d'outils -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold"><i class="bi bi-file-text"></i> Suivi des Contrats</h2>
            <div>
            <!-- Groupe de boutons de filtrage -->
            <div class="btn-group me-3" role="group">
            <button type="button" class="btn btn-outline-secondary active" onclick="filterTable('all')">Tous</button>
            <button type="button" class="btn btn-outline-primary" onclick="filterTable('EN_COURS')">En cours</button>
            <button type="button" class="btn btn-outline-info" onclick="filterTable('EN_ATTENTE')">En attente</button>
            <button type="button" class="btn btn-outline-danger" onclick="filterTable('EN_RETARD')">En retard</button>
            </div>

            <!-- Bouton de génération aléatoire -->
            <a href="/ui/contrats/random" class="btn btn-warning me-2" title="Générer un contrat aléatoire">
                <i class="bi bi-dice-5-fill"></i> Aléatoire
            </a>

            <!-- Bouton de scénario de démonstration -->
            <a href="/ui/contrats/scenario/retard" class="btn btn-danger me-2" title="Générer un scénario de conflit">
                <i class="bi bi-lightning-charge-fill"></i> Démo Conflit
            </a>

            <!-- Bouton de création -->
            <a href="/ui/contrats/new" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Nouveau
            </a>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle" id="contratTable">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Véhicule</th>
                            <th>Dates</th>
                            <th>Montant</th>
                            <th>État</th>
                            <th style="min-width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="c : ${contrats}" th:data-status="${c.etat}">
                            <td th:text="${'#' + c.id}" class="text-muted small"></td>
                            
                            <!-- Informations client -->
                            <td>
                                <div class="fw-bold" th:text="${c.client.nom + ' ' + c.client.prenom}"></div>
                            </td>
                            
                            <!-- Informations véhicule -->
                            <td>
                                <div th:text="${c.vehicule.marque + ' ' + c.vehicule.modele}"></div>
                                <div class="small text-muted" th:text="${c.vehicule.immatriculation}"></div>
                            </td>
                            
                            <!-- Plage de dates -->
                            <td>
                                <div th:text="${c.dateDebut}"></div>
                                <div class="small text-muted" th:text="'➔ ' + ${c.dateFin}"></div>
                            </td>
                            
                            <!-- Affichage du montant -->
                            <td class="text-success fw-bold" 
                                th:text="${c.prixTotal != null ? #numbers.formatCurrency(c.prixTotal) : '-'}">
                            </td>
                            
                            <!-- Étiquette d'état -->
                            <td>
                                <span th:text="${c.etat}"
                                      th:class="${'badge rounded-pill ' + 
                                      (c.etat.name() == 'EN_COURS' ? 'bg-primary' : 
                                      (c.etat.name() == 'EN_ATTENTE' ? 'bg-info text-dark' : 
                                      (c.etat.name() == 'EN_RETARD' ? 'bg-danger' : 
                                      (c.etat.name() == 'TERMINE' ? 'bg-success' : 'bg-secondary'))))}">
                                </span>
                            </td>
                            
                            <!-- Groupe de boutons d'action unifié -->
                            <td>
                                <div class="btn-group btn-group-sm">
                                    
                                    <!-- 1. Retourner le véhicule (coche verte) -->
                                    <a th:if="${c.etat.name() == 'EN_COURS' or c.etat.name() == 'EN_RETARD'}"
                                       th:href="@{/ui/contrats/terminer/{id}(id=${c.id})}"
                                       class="btn btn-outline-success" 
                                       title="Retourner le véhicule"
                                       onclick="return confirm('Confirmer que le véhicule a été retourné ?')">
                                        <i class="bi bi-check-lg"></i>
                                    </a>
                                    
                                    <!-- 2. Marquer en retard (Sablier jaune) -->
                                    <a th:if="${c.etat.name() == 'EN_COURS'}"
                                       th:href="@{/ui/contrats/retard/{id}(id=${c.id})}"
                                       class="btn btn-outline-warning" 
                                       title="Marquer comme en retard">
                                        <i class="bi bi-hourglass-split"></i>
                                    </a>
                                    
                                    <!-- 3. Modifier (Crayon bleu) -->
                                    <a th:href="@{/ui/contrats/edit/{id}(id=${c.id})}" 
                                       class="btn btn-outline-primary" 
                                       title="Modifier le contrat">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    
                                    <!-- 4. Supprimer (Corbeille rouge) -->
                                    <a th:href="@{/ui/contrats/delete/{id}(id=${c.id})}" 
                                       class="btn btn-outline-danger" 
                                       title="Supprimer le contrat" 
                                       onclick="return confirm('Confirmer la suppression ?')">
                                        <i class="bi bi-trash-fill"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function filterTable(status) {
            const rows = document.querySelectorAll('#contratTable tbody tr');
            document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            rows.forEach(row => {
                if (status === 'all' || row.dataset.status === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
    </script>
    <footer th:replace="~{fragments/layout :: footer}"></footer>
</body>
</html>